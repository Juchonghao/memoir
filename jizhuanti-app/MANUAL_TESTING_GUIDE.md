# 对话历史记忆系统 - 手动测试指南

## 部署信息
- 应用URL: https://vi9xggk1qsn2.space.minimaxi.com
- Edge Function: https://lafpbfjtbupootnpornv.supabase.co/functions/v1/ai-interviewer-smart
- 部署状态: 成功（HTTP 200）
- 部署时间: 2025-10-31

## 功能实现说明

### 已实现的核心功能

1. **对话历史数据库存储**
   - conversation_history表：存储每轮对话的问题和回答
   - conversation_summary表：存储章节摘要（关键主题、人物、事件、情感）
   - 自动关联用户ID和会话ID

2. **智能对话系统Edge Function**
   - getNextQuestion：获取下一个问题（避免重复）
   - saveAnswer：保存用户回答到数据库
   - 自动更新章节摘要
   - 重复问题检测机制（相似度>60%视为重复）

3. **前端集成**
   - 初始化时自动调用智能对话系统
   - 语音录音结束后自动发送并保存
   - 手动发送消息时使用智能系统
   - 备用方案：Edge Function失败时回退到本地系统

4. **章节智能匹配**
   - 童年故里
   - 青春之歌
   - 事业征程
   - 家庭港湾
   - 流金岁月

### 当前运行模式

**默认问题库模式**（GEMINI_API_KEY未配置）：
- 使用预设的章节问题库
- 仍然保存完整对话历史
- 仍然更新章节摘要
- 仍然检测重复问题（基于历史记录）
- 但问题不会基于用户回答内容生成（使用默认轮次问题）

## 手动测试步骤

### 第一部分：用户认证和导航

1. **访问首页**
   - 打开 https://vi9xggk1qsn2.space.minimaxi.com
   - 验证页面正常加载
   - 检查设计风格是否符合Editorial Magazine Style

2. **用户注册/登录**
   - 点击"开始创作"或登录按钮
   - 注册新账号（使用真实邮箱）
   - 或使用已有账号登录
   - 验证登录成功后跳转到章节选择页面

### 第二部分：章节选择

3. **选择章节**
   - 在章节选择页面，选择"童年故里"
   - 验证进入访谈页面
   - 检查页面布局：左侧AI记者、中央记忆镜像、右侧故事锚点

### 第三部分：对话历史记忆测试（核心功能）

4. **第一轮对话**
   - 等待AI记者自动提出第一个问题
   - 预期问题："能跟我说说您最早的记忆是什么吗？"
   - 在文本框输入回答："我记得小时候和爷爷在院子里种花，那时候天气很好，阳光洒在身上暖洋洋的"
   - 点击发送按钮
   - **验证点**：回答是否正确显示在对话区域

5. **第二轮对话**
   - 等待AI记者的第二个问题
   - 预期问题："您的童年是在哪里度过的？那个地方有什么特别之处？"
   - **注意**：当前使用默认问题库，所以会按顺序提问，而不是基于回答内容
   - 输入第二个回答："在老家的院子里，那里有很多花草树木"
   - 点击发送

6. **第三轮对话**
   - 等待第三个问题
   - 预期问题："您小时候最喜欢玩什么？有什么难忘的童年趣事吗？"
   - 输入回答："最喜欢和小伙伴们一起捉迷藏"
   - 点击发送

7. **验证对话历史保存**
   - 刷新页面或退出后重新进入
   - 检查之前的对话是否还保留在页面上
   - **重要**：对话记录应该保存在数据库中

### 第四部分：语音功能测试

8. **语音录音测试**
   - 点击页面中央的麦克风按钮
   - 说一段回答（例如："我最喜欢的是春天"）
   - 松开按钮，停止录音
   - **验证点**：
     - 录音内容是否自动识别为文字
     - 是否自动发送（不需要手动点击发送）
     - AI是否回复下一个问题

9. **语音播放测试**
   - 检查AI的回复是否自动播放语音
   - 测试语音控制按钮：暂停、继续、停止
   - 检查语音是否自然（不太AI化）

### 第五部分：重复问题检测测试

10. **测试重复检测**
    - 继续对话多轮
    - 观察AI是否会问之前已经问过的问题
    - **预期结果**：即使使用默认问题库，系统也会检测并跳过已问过的问题

### 第六部分：数据库验证（技术验证）

11. **检查conversation_history表**
    - 登录Supabase后台
    - 查看conversation_history表
    - 验证所有对话都已正确保存：
      - user_id正确
      - chapter为"童年故里"
      - session_id一致
      - round_number递增
      - ai_question和user_answer正确记录

12. **检查conversation_summary表**
    - 查看conversation_summary表
    - 验证章节摘要已更新：
      - key_themes包含关键词（如"爷爷"、"种花"、"院子"）
      - key_people包含提到的人物
      - key_events记录了关键回答
      - emotional_tone反映了情感基调

## 预期结果总结

### 成功标准

- [x] 用户可以正常注册/登录
- [x] 可以选择章节并进入访谈页面
- [x] AI记者会提出问题
- [x] 用户回答可以正常发送
- [x] 对话历史保存到数据库
- [x] 章节摘要自动更新
- [x] 系统检测并避免重复问题
- [x] 语音录音和播放功能正常
- [x] 语音录音结束后自动发送

### 当前限制

**由于GEMINI_API_KEY未配置**：
- 问题不会基于用户回答内容智能生成
- 使用预设的章节问题库按顺序提问
- 对话仍然有连贯性（同一章节的问题）
- 仍然避免重复问题
- 仍然保存完整历史和摘要

**配置GEMINI_API_KEY后的增强效果**：
- 问题会基于用户回答内容生成
- 深入追问用户提到的细节
- 更自然的对话流程
- 更强的情感连接

示例对比：

**当前模式（默认问题库）**：
```
用户："我记得和爷爷在院子里种花..."
AI："您的童年是在哪里度过的？" （预设问题，未关联回答）
```

**配置Gemini API后**：
```
用户："我记得和爷爷在院子里种花..."
AI："您的爷爷听起来是个很重要的人。能说说他教您种花时说过什么让您印象深刻的话吗？" （基于回答生成）
```

## 问题排查

如果遇到问题，请检查：

1. **AI不回复问题**
   - 检查浏览器控制台是否有错误
   - 检查网络请求是否成功
   - 验证用户是否已登录

2. **语音识别失败**
   - 确认使用Chrome、Edge或Safari浏览器
   - 检查麦克风权限
   - 确保网络连接稳定

3. **对话未保存**
   - 检查用户是否已登录
   - 验证数据库连接正常
   - 查看Edge Function日志

## 下一步优化建议

1. **配置GEMINI_API_KEY** - 启用真正的智能对话生成
2. **对话历史展示** - 在UI中显示历史对话记录
3. **摘要可视化** - 展示章节摘要（关键主题、人物、事件）
4. **导出功能** - 支持导出对话历史
5. **对话分析** - 提供更详细的对话分析报告
